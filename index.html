<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner Gudang</title>
    <script src="https://unpkg.com/html5-qrcode"></script> 
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            text-align: center;
            background-color: #f0f0f0;
        }
        #reader {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border: 2px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }
        #reader__dashboard_section_csr {
            padding: 15px;
            background-color: #333;
            color: white;
            font-size: 1.1em;
        }
        #result {
            margin-top: 20px;
            font-weight: bold;
            color: green;
        }
    </style>
</head>
<body>

    <h2>Scan Barang Gudang</h2>
    <p>Setelah scan sukses, tambahkan perintah /out atau /re di chat.</p>
    
    <div id="reader"></div>
    <div id="result"></div>

    <script>
        // --- INISIALISASI VARIABEL GLOBAL ---
        const html5Qrcode = new Html5Qrcode("reader");
        const config = { 
            fps: 10, 
            qrbox: {width: 250, height: 250}
        };
        
        // --- LOGIKA UTAMA SCANNER ---
        
        // Fungsi utama yang dipanggil setelah QR Code berhasil dibaca
        function onScanSuccess(decodedText, decodedResult) {
            // 1. Tampilkan hasil di layar Mini App
            document.getElementById('result').innerHTML = `Kode Terbaca: <b>${decodedText}</b>`;
            
            // 2. Hentikan scanning SEBELUM berinteraksi dengan Telegram API
            html5Qrcode.stop().then((ignore) => {
                // Proses mengirim data dan menutup hanya dieksekusi setelah stop berhasil
                try {
                    // Mengatur teks input chat Telegram dengan default "/out " di depannya
                    Telegram.WebApp.setText('/out ' + decodedText); 
                    
                    // Memberikan feedback haptic (getaran) sukses pada HP
                    Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    
                    // 3. Tutup Mini App
                    Telegram.WebApp.close();
                } catch (error) {
                    console.error("Gagal mengirim data ke Telegram:", error);
                    document.getElementById('result').innerHTML += '<br>❌ GAGAL KIRIM DATA KE BOT. Silakan coba lagi.';
                }
            }).catch((err) => {
                // Jika gagal stop (jarang terjadi)
                console.error("Gagal menghentikan scanner:", err);
                document.getElementById('result').innerHTML += '<br>❌ Gagal menghentikan scanner.';
            });
        }

        // Fungsi yang dipanggil ketika scan gagal (diabaikan, hanya untuk logging)
        function onScanFailure(error) {
            // console.warn(`Code scan error = ${error}`);
        }

        // --- INISIALISASI KAMERA DAN SCANNER ---
        
        // Dapatkan daftar kamera dan paksa kamera belakang
        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {
                // Cari kamera belakang
                let cameraId = devices.find(device => 
                    device.label.toLowerCase().includes('back') || 
                    device.label.toLowerCase().includes('rear') ||
                    (devices.length > 1 && device.id === devices[devices.length - 1].id) 
                );
                
                // Tentukan kamera yang akan digunakan (kamera belakang atau kamera pertama)
                let cameraToUse = cameraId ? cameraId.id : devices[0].id;
                
                // Mulai scan dengan ID kamera yang spesifik
                html5Qrcode.start(
                    cameraToUse, 
                    config, 
                    onScanSuccess, 
                    onScanFailure
                ).catch(err => {
                     document.getElementById('result').innerHTML = `❌ Gagal Memulai Kamera: Pastikan Anda memberikan izin kamera.`;
                     console.error(err);
                });

            } else {
                document.getElementById('result').innerHTML = "❌ Tidak ada kamera yang ditemukan.";
            }
        }).catch(err => {
            document.getElementById('result').innerHTML = "❌ Gagal mendapatkan daftar kamera.";
            console.error(err);
        });

        // --- PENTING: Initialization API Telegram ---
        Telegram.WebApp.ready();
    </script>

</body>
</html>